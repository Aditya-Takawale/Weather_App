<div class="dashboard-container">
  <!-- NGX UI Loader -->
  <ngx-ui-loader></ngx-ui-loader>
  
  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading()">
    <mat-spinner></mat-spinner>
    <p>Loading weather data...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="error() && !loading()">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ error() }}</p>
    <button mat-raised-button color="primary" (click)="refreshData()">Retry</button>
  </div>

  <!-- Main Dashboard Grid -->
  <div class="weather-dashboard" *ngIf="currentWeather() && !loading() && !error()">
      
      <!-- Left Column -->
      <div class="left-column">
        
        <!-- Main Temperature Card -->
        <div class="main-temp-card" *ngIf="currentWeather()">
          <div class="temp-icon">
            <mat-icon>wb_sunny</mat-icon>
          </div>
          <div class="temp-value">{{ currentWeather()!.temperature | number:'1.1-1' }}°C</div>
          <div class="feels-like">Feels Like<br>{{ currentWeather()!.feelsLike | number:'1.1-1' }}°C</div>
        </div>

        <!-- 5-Day Forecast -->
        <div class="forecast-card">
          <div class="forecast-day" *ngFor="let day of weekForecast()">
            <div class="day-name">{{ day.name }}</div>
            <mat-icon *ngIf="day.icon">{{ day.icon }}</mat-icon>
            <div class="day-temp">{{ day.high }}°<br><span class="low-temp">{{ day.low }}°</span></div>
          </div>
          <div *ngIf="weekForecast().length === 0" class="no-forecast">
            <p>No forecast data available</p>
          </div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section">
          <div class="alert-item">
            <mat-icon>warning_amber</mat-icon>
            <div class="alert-info">
              <span class="alert-label">NWS Alerts</span>
              <span class="alert-value">{{ activeAlerts().length }}</span>
            </div>
          </div>
          <div class="alert-item" *ngIf="activeAlerts().length > 0">
            <mat-icon>flash_on</mat-icon>
            <div class="alert-info">
              <span class="alert-label">Active Alert</span>
              <span class="alert-value">{{ activeAlerts()[0].severity }}</span>
            </div>
          </div>
          <div class="alert-item" *ngIf="activeAlerts().length === 0">
            <mat-icon>check_circle</mat-icon>
            <div class="alert-info">
              <span class="alert-label">Lightning</span>
              <span class="alert-value">0</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Middle Column -->
      <div class="middle-column">
        
        <!-- Wind Information -->
        <div class="info-card">
          <div class="card-title">Wind</div>
          <div class="wind-section" *ngIf="currentWeather()">
            <div class="wind-item">
              <span class="label">Speed</span>
              <span class="value">{{ currentWeather()!.windSpeed | number:'1.1-1' }} km/h</span>
            </div>
            <div class="wind-compass">
              <div class="compass-dial" [style.transform]="'rotate(' + currentWeather()!.windDirection + 'deg)'">
                <mat-icon>navigation</mat-icon>
              </div>
              <div class="wind-speed">{{ currentWeather()!.windSpeed | number:'1.1-1' }} km/h</div>
            </div>
            <div class="wind-item">
              <span class="label">Gusts</span>
              <span class="value">{{ (currentWeather()!.windGust || currentWeather()!.windSpeed) | number:'1.1-1' }} km/h</span>
            </div>
            <div class="wind-item full-width">
              <span class="label">Direction</span>
              <span class="value">{{ currentWeather()!.windDirection }}° {{ getWindDirection(currentWeather()!.windDirection) }}</span>
            </div>
          </div>
        </div>

        <!-- Humidity -->
        <div class="info-card">
          <div class="card-title">Humidity</div>
          <div class="humidity-section" *ngIf="currentWeather()">
            <div class="humidity-value">{{ currentWeather()!.humidity }}%</div>
            <div class="dew-point">The dew point is {{ calculateDewPoint(currentWeather()!.temperature, currentWeather()!.humidity) }}°C right now</div>
          </div>
        </div>

        <!-- Rain Information -->
        <div class="info-card rain-card">
          <div class="card-title">Rain</div>
          <div class="rain-section" *ngIf="currentWeather()">
            <div class="rain-item">
              <mat-icon>water_drop</mat-icon>
              <div>
                <div class="rain-value">0.0 mm</div>
                <div class="rain-label">this hour</div>
              </div>
            </div>
            <div class="rain-item">
              <mat-icon>grain</mat-icon>
              <div>
                <div class="rain-value">0.0 mm</div>
                <div class="rain-label">today</div>
              </div>
            </div>
          </div>
          <div *ngIf="!currentWeather()" class="rain-section">
            <p>No rain data available</p>
          </div>
        </div>

        <!-- Pressure -->
        <div class="info-card">
          <div class="card-title">Atmospheric Pressure</div>
          <div class="pressure-section" *ngIf="currentWeather()">
            <div class="pressure-gauge">
              <div class="gauge-value">{{ currentWeather()!.pressure }} hPa</div>
            </div>
          </div>
          <div *ngIf="!currentWeather()" class="pressure-section">
            <p>No pressure data available</p>
          </div>
        </div>

        <!-- UV Index -->
        <div class="info-card uv-card">
          <div class="card-title">
            <mat-icon>wb_sunny</mat-icon>
            <span>UV Index</span>
          </div>
          <div *ngIf="uvData()">
            <div class="quality-value">{{ uvData()?.uvIndex || 0 }}</div>
            <div class="quality-label">{{ uvData()?.label || 'N/A' }}</div>
            <div class="quality-bar">
              <div class="bar-fill" [style.width.%]="(uvData()?.uvIndex || 0) * 10"></div>
            </div>
          </div>
          <div *ngIf="!uvData()" class="no-data">
            <p>No UV data available</p>
          </div>
        </div>

        <!-- Air Quality -->
        <div class="info-card aqi-card">
          <div class="card-title">
            <mat-icon>air</mat-icon>
            <span>Air Quality</span>
          </div>
          <div *ngIf="airQualityData()">
            <div class="quality-value">{{ airQualityData()?.aqi || 0 }}</div>
            <div class="quality-label">{{ airQualityData()?.label || 'N/A' }}</div>
            <div class="quality-bar">
              <div class="bar-fill aqi" [style.width.%]="airQualityData()?.aqi || 0"></div>
            </div>
          </div>
          <div *ngIf="!airQualityData()" class="no-data">
            <p>No air quality data available</p>
          </div>
        </div>

      </div>

      <!-- Right Column -->
      <div class="right-column">
        
        <!-- Moon Phase Card -->
        <div class="moon-card">
          <div class="moon-title">Moon Phase</div>
          <div class="moon-info" *ngIf="moonData()">
            <div class="moon-item">
              <span class="label">Illumination</span>
              <span class="value">{{ moonData()?.illumination || 0 }}%</span>
            </div>
            <div class="moon-icon">
              <mat-icon>brightness_3</mat-icon>
            </div>
            <div class="moon-item">
              <span class="label">Moonrise</span>
              <span class="value">in {{ moonData()?.moonriseIn || 'N/A' }}</span>
            </div>
          </div>
          <div class="moon-phase" *ngIf="moonData()">
            <span class="label">Next Full Moon</span>
            <span class="value">{{ moonData()?.nextFullMoon || 'N/A' }}</span>
          </div>
          <div *ngIf="!moonData()" class="no-data">
            <p>No moon data available</p>
          </div>
        </div>

        <!-- Map Section -->
        <div class="map-card">
          <div class="map-header">
            <button mat-button [class.active]="mapLayer === 'alerts'">Alerts</button>
            <button mat-button [class.active]="mapLayer === 'radar'">Mount Carmel</button>
            <button mat-button [class.active]="mapLayer === 'precip'">Precip</button>
          </div>
          <div class="map-container">
            <div class="map-placeholder">
              <mat-icon>map</mat-icon>
              <p>Map View - {{ city }}</p>
              <p class="map-note">Interactive map integration pending</p>
            </div>
          </div>
          <div class="map-timestamp">{{ currentTime }}</div>
        </div>

      </div>

    </div>
  
</div>
